export interface CarFeatureGroup {
  key: string;
  title: string;
  description?: string;
  items: string[];
}

export const CAR_FEATURE_GROUPS: CarFeatureGroup[] = [
  {
    key: "безопасност",
    title: "Безопасност",
    description: "Системи за активна и пасивна безопасност",
    items: [
      "GPS система за проследяване",
      "Автоматичен контрол на стабилността",
      "Адаптивни предни светлини",
      "Антиблокираща система",
      "Въздушни възглавници - Задни",
      "Въздушни възглавници - Предни",
      "Въздушни възглавници - Странични",
      "Ел. разпределяне на спирачното усилие",
      "Електронна програма за стабилизиране",
      "Контрол на налягането на гумите",
      "Парктроник",
      "Система ISOFIX",
      "Система за динамична устойчивост",
      "Система за защита от пробуксуване",
      "Система за изсушаване на накладките",
      "Система за контрол на дистанцията",
      "Система за контрол на спускането",
      "Система за подпомагане на спирането",
    ],
  },
  {
    key: "комфорт",
    title: "Комфорт",
    description: "Климат, удобства и асистиращи функции",
    items: [
      "Auto Start Stop function",
      "Bluetooth \\ handsfree система",
      "DVD, TV",
      "Steptronic, Tiptronic",
      "USB, audio/video, IN/AUX изводи",
      "Адаптивно въздушно окачване",
      "Безключово палене",
      "Блокаж на диференциала",
      "Бордкомпютър",
      "Бързи / бавни скорости",
      "Датчик за светлина",
      "Ел. Огледала",
      "Ел. Стъкла",
      "Ел. регулиране на окачването",
      "Ел. регулиране на седалките",
      "Ел. усилвател на волана",
      "Климатик",
      "Климатроник",
      "Мултифункционален волан",
      "Навигация",
      "Отопление на волана",
      "Печка",
      "Подгряване на предното стъкло",
      "Подгряване на седалките",
      "Регулиране на волана",
      "Сензор за дъжд",
      "Серво усилвател на волана",
      "Система за измиване на фаровете",
      "Система за контрол на скоростта (автопилот)",
      "Стерео уредба",
      "Термопомпа",
      "Хладилна жабка",
    ],
  },
  {
    key: "защита",
    title: "Защита",
    description: "Сигурност и противокражбени екстри",
    items: [
      "OFFROAD пакет",
      "Аларма",
      "Брониран",
      "Каско",
      "Лебедка",
      "Централно заключване",
    ],
  },
  {
    key: "интериор",
    title: "Интериор",
    description: "Салон и вътрешно оборудване",
    items: [
      "Велурен салон",
      "Десен волан",
      "Кожен салон",
    ],
  },
  {
    key: "специализирани",
    title: "Специализирани",
    description: "Специално предназначение",
    items: [
      "TAXI",
      "За хора с увреждания",
      "Катафалка",
      "Линейка",
      "Учебен",
      "Хладилен",
      "Хомологация N1",
    ],
  },
  {
    key: "екстериор",
    title: "Екстериор",
    description: "Външен вид и външни елементи",
    items: [
      "2(3) Врати",
      "4(5) Врати",
      "LED фарове",
      "Ксенонови фарове",
      "Лети джанти",
      "Металик",
      "Панорамен люк",
      "Рейлинг на покрива",
      "Спойлери",
      "Теглич",
      "Халогенни фарове",
      "Шибедах",
    ],
  },
  {
    key: "други",
    title: "Други",
    description: "Допълнителни характеристики на обявата",
    items: [
      "4x4",
      "7 места",
      "Buy back",
      "Бартер",
      "Газова уредба",
      "Дълга база",
      "Капариран/Продаден",
      "Катастрофирал",
      "Къса база",
      "Лизинг",
      "Метанова уредба",
      "На части",
      "Напълно обслужен",
      "Нов внос",
      "С регистрация",
      "Сервизна книжка",
      "Тунинг",
    ],
  },
];

export const CAR_FEATURES: Record<string, string[]> = CAR_FEATURE_GROUPS.reduce(
  (acc, group) => {
    acc[group.key] = group.items;
    return acc;
  },
  {} as Record<string, string[]>
);

const CAR_FEATURE_ALIASES: Record<string, string> = {
  "Bluetooth handsfree система": "Bluetooth \\ handsfree система",
  "Bluetooth / handsfree система": "Bluetooth \\ handsfree система",
  "Bluetooth\\ handsfree система": "Bluetooth \\ handsfree система",
  "Bluetooth": "Bluetooth \\ handsfree система",
  "USB": "USB, audio/video, IN/AUX изводи",
  "AUX": "USB, audio/video, IN/AUX изводи",
  "ABS": "Антиблокираща система",
  "ESP": "Електронна програма за стабилизиране",
  "Тракшън контрол": "Система за защита от пробуксуване",
  "Круиз контрол": "Система за контрол на скоростта (автопилот)",
  "Адаптивен круиз контрол": "Система за контрол на скоростта (автопилот)",
  "Автоматични светлини": "Датчик за светлина",
  "LED светлини": "LED фарове",
  "Ксенонови светлини": "Ксенонови фарове",
  "Алуминиеви джанти": "Лети джанти",
  "Панорамен покрив": "Панорамен люк",
  "Люк": "Шибедах",
  "Електрически огледала": "Ел. Огледала",
  "Електрически прозорци": "Ел. Стъкла",
  "Отопляеми седалки": "Подгряване на седалките",
  "Отопляемо предно стъкло": "Подгряване на предното стъкло",
  "Волан с отопление": "Отопление на волана",
  "Регулируемо волан": "Регулиране на волана",
  "Паркинг сензори": "Парктроник",
  "Start/Stop": "Auto Start Stop function",
  "Xenon": "Ксенонови фарове",
  "Isofix": "Система ISOFIX",
  "Rear camera": "Парктроник",
  "Airbags": "Въздушни възглавници - Предни",
  "Air conditioning": "Климатик",
  "Climate control": "Климатроник",
  "Adaptive cruise": "Система за контрол на скоростта (автопилот)",
  "Navigation": "Навигация",
  "Keyless entry": "Безключово палене",
};

export const normalizeCarFeatureLabel = (feature: unknown): string => {
  const value = String(feature ?? "").trim();
  if (!value) return "";
  return CAR_FEATURE_ALIASES[value] || value;
};

export const normalizeCarFeatures = (features: unknown): string[] => {
  const rawList = (() => {
    if (Array.isArray(features)) return features;
    if (typeof features === "string") {
      try {
        const parsed = JSON.parse(features);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }
    return [];
  })();

  const normalized = rawList
    .map((feature) => normalizeCarFeatureLabel(feature))
    .filter(Boolean);

  return Array.from(new Set(normalized));
};

export type FeatureCategory = keyof typeof CAR_FEATURES;
